<!-- 背景音乐播放器控制面板 -->
<div id="music-player-panel" style="position: fixed; top: 20px; right: 20px; z-index: 1000; background: rgba(255, 255, 255, 0.95); border-radius: 15px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 250px;">
  <div style="display: flex; align-items: center; gap: 12px;">
    <!-- 播放/暂停按钮 -->
    <button id="toggle-music-btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 50%; width: 45px; height: 45px; cursor: pointer; font-size: 18px; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4); transition: all 0.3s;" title="播放/暂停音乐">⏸</button>
    
    <div style="flex: 1;">
      <!-- 音乐标题 -->
      <div style="font-size: 14px; font-weight: 600; color: #333; margin-bottom: 4px;">背景音乐</div>
      
      <!-- 进度条和音量控制 -->
      <div style="display: flex; align-items: center; gap: 8px;">
        <span style="font-size: 12px; color: #666;">🔊</span>
        <input type="range" id="volume-control" min="0" max="100" value="30" style="flex: 1; height: 4px; border-radius: 2px; outline: none;" title="音量">
        <span style="font-size: 11px; color: #666; min-width: 30px; text-align: right;" id="volume-display">30%</span>
      </div>
    </div>
    
    <!-- 关闭按钮 -->
    <button id="close-music-btn" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #999; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;" title="关闭音乐">×</button>
  </div>
</div>

<audio id="background-music" loop preload="none" volume="0.3">
  <!-- 使用MP3格式，将你的音乐文件命名为 background.mp3 并放在 static/music/ 目录下 -->
  <source src="/huiwang/music/background.mp3" type="audio/mpeg">
  <!-- 兼容性提示 -->
  你的浏览器不支持音频播放
</audio>

<script>
(function() {
  const player = document.getElementById('background-music');
  const toggleBtn = document.getElementById('toggle-music-btn');
  const volumeControl = document.getElementById('volume-control');
  const volumeDisplay = document.getElementById('volume-display');
  const closeBtn = document.getElementById('close-music-btn');
  const musicPanel = document.getElementById('music-player-panel');
  
  let isPlaying = false; // 初始状态为未播放
  let isMinimized = false;
  
  // 设置初始音量
  player.volume = 0.3;
  
  // 尝试自动播放
  function tryAutoplay() {
    const playPromise = player.play();
    
    if (playPromise !== undefined) {
      playPromise
        .then(() => {
          console.log('🎵 音乐自动播放成功');
          isPlaying = true;
          toggleBtn.textContent = '⏸';
        })
        .catch(error => {
          console.log('⚠️ 自动播放被阻止:', error);
          isPlaying = false;
          toggleBtn.textContent = '▶';
        });
    }
  }
  
  // 页面加载后尝试自动播放
  if (document.readyState === 'complete') {
    setTimeout(tryAutoplay, 500);
  } else {
    window.addEventListener('load', function() {
      setTimeout(tryAutoplay, 500);
    });
  }
  
  // 切换播放/暂停
  toggleBtn.addEventListener('click', function() {
    if (isPlaying) {
      player.pause();
      toggleBtn.textContent = '▶';
      isPlaying = false;
    } else {
      player.play();
      toggleBtn.textContent = '⏸';
      isPlaying = true;
    }
  });
  
  // 音量控制
  volumeControl.addEventListener('input', function() {
    const volume = this.value / 100;
    player.volume = volume;
    volumeDisplay.textContent = this.value + '%';
  });
  
  // 添加一个小的浮动按钮来重新显示播放面板
  const showMusicBtn = document.createElement('button');
  showMusicBtn.innerHTML = '🎵';
  showMusicBtn.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 999; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; cursor: pointer; font-size: 20px; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4); display: none; transition: all 0.3s;';
  showMusicBtn.title = '显示音乐控制';
  document.body.appendChild(showMusicBtn);
  
  // 显示浮动按钮
  showMusicBtn.addEventListener('click', function() {
    musicPanel.style.display = 'block';
    showMusicBtn.style.display = 'none';
  });
  
  // 关闭按钮 - 完全隐藏播放面板
  closeBtn.addEventListener('click', function() {
    musicPanel.style.display = 'none';
    player.pause(); // 关闭时暂停音乐
    isPlaying = false;
    toggleBtn.textContent = '▶'; // 更新按钮状态
    
    // 延迟显示浮动按钮
    setTimeout(() => {
      showMusicBtn.style.display = 'block';
    }, 300);
  });
  
  // 监听播放状态变化
  player.addEventListener('play', function() {
    toggleBtn.textContent = '⏸';
    isPlaying = true;
  });
  
  player.addEventListener('pause', function() {
    toggleBtn.textContent = '▶';
    isPlaying = false;
  });
  
})();
</script>

<style>
@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

#toggle-music-btn:hover {
  animation: pulse 0.6s ease-in-out;
  transform: scale(1.1);
}

#volume-control::-webkit-slider-thumb {
  appearance: none;
  width: 14px;
  height: 14px;
  border-radius: 50%;
  background: #667eea;
  cursor: pointer;
}

#volume-control::-moz-range-thumb {
  width: 14px;
  height: 14px;
  border-radius: 50%;
  background: #667eea;
  cursor: pointer;
  border: none;
}

@media (max-width: 768px) {
  div[style*="position: fixed"] {
    bottom: 10px !important;
    right: 10px !important;
    left: 10px !important;
    min-width: auto !important;
  }
}
</style>

